<?xml version="1.0" encoding="UTF-8"?>
<!--
 Copyright 2011 Sebastien M-B <essembeh@gmail.com>
 
 This file is part of RegexTagForMusic.
 
 RegexTagForMusic is free software: you can redistribute it and/or modify it
 under the terms of the GNU General Public License as published by the Free
 Software Foundation, either version 3 of the License, or (at your option) any
 later version.
 
 RegexTagForMusic is distributed in the hope that it will be useful, but
 WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 details.
  
 You should have received a copy of the GNU General Public License along with
 RegexTagForMusic. If not, see <http://www.gnu.org/licenses/>.
-->
<project basedir="." default="dist">
	<property name="app.name" value="rtfm" />
	<property name="app.version" value="1.0alpha2" />
	<property name="app.root" value="." />
	<property name="src.app" value="${app.root}/src" />
	<property name="src.junit" value="${app.root}/junit" />
	<property name="lib" value="${app.root}/lib" />
	<property name="res" value="${app.root}/res" />
	<property name="dist" value="${app.root}/dist" />
	<property name="build" value="${dist}/build" />
	<property name="build.app" value="${build}/app" />
	<property name="build.junit" value="${build}/junit" />
	<property name="mf.builtby" value="Sebastien M-B: essembeh@gmail.com" />
	<property name="mf.mainclass" value="org.essembeh.rtfm.starter.MainClass" />
	<property name="jar" value="${dist}/${app.name}-${app.version}.jar" />

	<target name="clean">
		<delete dir="${build}" />
		<delete dir="${dist}" />
	</target>

	<!--
		BUILDING
	-->
	<path id="app.classpath">
		<fileset dir="${lib}">
			<include name="*.jar" />
		</fileset>
	</path>

	<target name="buildapp" depends="">
		<mkdir dir="${build}" />
		<mkdir dir="${build.app}" />
		<mkdir dir="${build.junit}" />
		<javac srcdir="${src.app}" destdir="${build.app}" includes="**" includeantruntime="no">
			<classpath refid="app.classpath" />
		</javac>
		<copy file="res/log4j.xml" todir="${build.app}" overwrite="true" />
	</target>


	<target name="dist" depends="buildapp">
		<mkdir dir="${dist}" />
		<copy todir="${dist}">
			<fileset file="${lib}/log4j*.jar" />
		</copy>
		<copy file="res/config.xml" todir="${dist}" overwrite="true" />
		<!-- Convert project class path to string property -->
		<pathconvert property="mf.classpath" pathsep=" ">
			<path refid="app.classpath" />
			<flattenmapper />
		</pathconvert>
		<jar basedir="${build.app}" destfile="${jar}">
			<manifest>
				<attribute name="Built-By" value="${mf.builtby}" />
				<attribute name="Main-Class" value="${mf.mainclass}" />
				<attribute name="Class-Path" value=". ${mf.classpath}" />
			</manifest>
		</jar>
	</target>

	<!--
		JUNIT
	-->
	<path id="junit.classpath">
		<fileset dir="${lib}">
			<include name="*.jar" />
		</fileset>
		<pathelement location="${build.app}" />
		<pathelement location="${build.junit}" />
		<pathelement location="${res}" />
	</path>
	<target name="buildjunit" depends="buildapp">
		<javac srcdir="${src.junit}" destdir="${build.junit}" includes="**" includeantruntime="no">
			<classpath refid="junit.classpath" />
		</javac>
	</target>
	<target name="test" depends="buildjunit">
		<junit fork="yes" haltonfailure="no">
			<batchtest fork="yes" todir="${build}">
				<fileset dir="${build.junit}">
					<include name="**/*Test.class" />
				</fileset>
			</batchtest>
			<formatter type="xml" />
			<classpath refid="junit.classpath" />
		</junit>
	</target>

	<target name="seb" depends="dist">
		<copy file="${res}/config-seb.xml"  tofile="${dist}/config.xml" overwrite="true" />
	</target>

</project>
