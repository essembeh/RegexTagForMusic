<?xml version="1.0" encoding="UTF-8"?>
<configuration-core xmlns="http://rtfm.essembeh.org/ConfigurationCore" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<!-- Substitutions are applied only on "pattern" attributes -->
	<substitutions>
		<substitution key="@SEPARATOR" value=" - " />
		<substitution key="@ANYTHING" value="[^/]+" />
		<substitution key="@DOT-EXT" value="\.[a-zA-Z0-9]+" />
		<substitution key="@YEAR" value="[12]\d{3}" />
		<substitution key="@TRACKNUMBER" value="\d{2,3}" />
	</substitutions>
	<!-- File types -->
	<filehandlers>
		<filehandler id="Album mp3">
			<conditions logic="AND">
				<fileOrFilder type="FILE" />
				<virtualPathMatches pattern="/Albums/@ANYTHING/@ANYTHING/@TRACKNUMBER@SEPARATOR@ANYTHING@DOT-EXT" />
				<extension list="mp3" caseSensitive="true" />
			</conditions>
			<attributes>
				<attribute name="core:mime-type" value="audio/mp3" />
				<attribute name="core:export?" value="true" />
				<attribute name="music:tagged?" value="false" />
				<attribute name="music:comment" value="Tagged with RegexTagForMusic" />
				<regex-attribute name="music:artist" pattern="/Albums/(@ANYTHING)/((?:(@YEAR)@SEPARATOR)?@ANYTHING)/(@TRACKNUMBER)@SEPARATOR(@ANYTHING)@DOT-EXT" group="1" />
				<regex-attribute name="music:year" pattern="/Albums/(@ANYTHING)/((?:(@YEAR)@SEPARATOR)?@ANYTHING)/(@TRACKNUMBER)@SEPARATOR(@ANYTHING)@DOT-EXT" group="3" optional="true" />
				<regex-attribute name="music:album" pattern="/Albums/(@ANYTHING)/((?:(@YEAR)@SEPARATOR)?@ANYTHING)/(@TRACKNUMBER)@SEPARATOR(@ANYTHING)@DOT-EXT" group="2" />
				<regex-attribute name="music:track" pattern="/Albums/(@ANYTHING)/((?:(@YEAR)@SEPARATOR)?@ANYTHING)/(@TRACKNUMBER)@SEPARATOR(@ANYTHING)@DOT-EXT" group="4" />
				<regex-attribute name="music:title" pattern="/Albums/(@ANYTHING)/((?:(@YEAR)@SEPARATOR)?@ANYTHING)/(@TRACKNUMBER)@SEPARATOR(@ANYTHING)@DOT-EXT" group="5" />
			</attributes>
		</filehandler>
		<filehandler id="Cover">
			<conditions logic="AND">
				<fileOrFilder type="FILE" />
				<virtualPathMatches pattern="/Albums/@ANYTHING/@ANYTHING/cover@DOT-EXT" />
				<extension list="jpg png" caseSensitive="true" />
			</conditions>
			<attributes>
				<attribute name="core:export?" value="false" />
			</attributes>
		</filehandler>
		<filehandler id="Single mp3">
			<conditions logic="AND">
				<fileOrFilder type="FILE" />
				<virtualPathMatches pattern="/Singles/@ANYTHING@SEPARATOR@ANYTHING@DOT-EXT" />
				<extension list="mp3" caseSensitive="true" />
			</conditions>
			<attributes>
				<attribute name="core:mime-type" value="audio/mp3" />
				<attribute name="core:export?" value="true" />
				<attribute name="music:tagged?" value="false" />
				<attribute name="music:comment" value="Tagged with RegexTagForMusic" />
				<attribute name="music:album" value="#Single" />
				<regex-attribute name="music:artist" pattern="/Singles/(@ANYTHING)@SEPARATOR(@ANYTHING)@DOT-EXT" group="1" />
				<regex-attribute name="music:title" pattern="/Singles/(@ANYTHING)@SEPARATOR(@ANYTHING)@DOT-EXT" group="2" />
			</attributes>
		</filehandler>
		<filehandler id="Saga mp3">
			<conditions logic="AND">
				<fileOrFilder type="FILE" />
				<virtualPathMatches pattern="/Saga/@ANYTHING/@ANYTHING@DOT-EXT" />
				<extension list="mp3" caseSensitive="true" />
			</conditions>
			<attributes>
				<attribute name="core:mime-type" value="audio/mp3" />
				<attribute name="core:export?" value="true" />
				<attribute name="music:tagged?" value="false" />
				<attribute name="music:comment" value="Tagged with RegexTagForMusic" />
				<attribute name="music:album" value="#Saga" />
				<regex-attribute name="music:artist" pattern="/Saga/(@ANYTHING)/(@ANYTHING)@DOT-EXT" group="1" />
				<regex-attribute name="music:title" pattern="/Saga/(@ANYTHING)/(@ANYTHING)@DOT-EXT" group="2" />
			</attributes>
		</filehandler>
		<filehandler id="Artist folder">
			<conditions logic="AND">
				<fileOrFilder type="FOLDER" />
				<virtualPathMatches pattern="/Albums/@ANYTHING/" />
			</conditions>
			<attributes>
				<attribute name="core:export?" value="false" />
				<regex-attribute name="music:artist" pattern="/Albums/(@ANYTHING)/" group="1" />
			</attributes>
		</filehandler>
		<filehandler id="Album folder">
			<conditions logic="AND">
				<fileOrFilder type="FOLDER" />
				<virtualPathMatches pattern="/Albums/@ANYTHING/@ANYTHING/" />
			</conditions>
			<attributes>
				<attribute name="core:export?" value="false" />
				<attribute name="music:hasCover" value="false" />
				<regex-attribute name="music:artist" pattern="/Albums/(@ANYTHING)/(?:(@YEAR)@SEPARATOR)?(@ANYTHING)/" group="1" />
				<regex-attribute name="music:year" pattern="/Albums/(@ANYTHING)/(?:(@YEAR)@SEPARATOR)?(@ANYTHING)/" group="2" optional="true" />
				<regex-attribute name="music:album" pattern="/Albums/(@ANYTHING)/(?:(@YEAR)@SEPARATOR)?(@ANYTHING)/" group="3" />
			</attributes>
		</filehandler>
		<filehandler id="IGNORED">
			<conditions logic="OR">
				<virtualPathMatches pattern="/tmp.*" />
				<virtualPathMatches pattern=".*/\.DS_Store" />
			</conditions>
			<attributes>
				<attribute name="ui:hide" value="true" />
				<attribute name="core:export?" value="false" />
			</attributes>
		</filehandler>
		<filehandler id="UNKNOWN">
			<conditions logic="AND">
				<true />
			</conditions>
			<attributes>
				<attribute name="core:export?" value="false" />
			</attributes>
		</filehandler>
	</filehandlers>
	<!-- Tasks -->
	<tasks>
		<task id="setNonTagged" classname="org.essembeh.rtfm.tasks.UpdateAttributes">
			<property name="music:tagged?" value="false" />
		</task>
		<task id="setTagged" classname="org.essembeh.rtfm.tasks.UpdateAttributes">
			<property name="music:tagged?" value="true" />
		</task>
		<task id="JAudioTagger-id3v2.4" classname="org.essembeh.rtfm.tasks.JAudioTagger">
			<property name="version" value="ID3V2_4" />
		</task>
		<task id="JAudioTagger-id3v2.3" classname="org.essembeh.rtfm.tasks.JAudioTagger">
			<property name="version" value="ID3V2_3" />
		</task>
		<task id="eyed3-id3v2.4@utf8" classname="org.essembeh.rtfm.tasks.ExternalProcess">
			<property name="binary" value="scripts/eyeD3-tag.sh" />
			<property name="env.set" value="TAG_VERSION=ID3V2_4" />
			<property name="env.set" value="TAG_FORCEUTF8=true" />
			<property name="env.set" value="RTFM_ARTIST=${music:artist}" />
			<property name="env.set" value="RTFM_ALBUM=${music:album}" />
			<property name="env.set" value="RTFM_YEAR=${music:year}" />
			<property name="env.set" value="RTFM_TITLE=${music:title}" />
			<property name="env.set" value="RTFM_TRACK=${music:track}" />
			<property name="env.set" value="RTFM_GENRE=${music:genre}" />
			<property name="env.set" value="RTFM_COMMENT=${music:comment}" />
		</task>
		<task id="eyed3-id3v2.3" classname="org.essembeh.rtfm.tasks.ExternalProcess">
			<property name="binary" value="scripts/eyeD3-tag.sh" />
			<property name="env.set" value="TAG_VERSION=ID3V2_3" />
			<property name="env.set" value="TAG_FORCEUTF8=true" />
			<property name="env.set" value="RTFM_ARTIST=${music:artist}" />
			<property name="env.set" value="RTFM_ALBUM=${music:album}" />
			<property name="env.set" value="RTFM_YEAR=${music:year}" />
			<property name="env.set" value="RTFM_TITLE=${music:title}" />
			<property name="env.set" value="RTFM_TRACK=${music:track}" />
			<property name="env.set" value="RTFM_GENRE=${music:genre}" />
			<property name="env.set" value="RTFM_COMMENT=${music:comment}" />
		</task>
		<task id="eyed3-clean" classname="org.essembeh.rtfm.tasks.ExternalProcess">
			<property name="binary" value="scripts/eyeD3-remove.sh" />
		</task>
		<task id="echo" classname="org.essembeh.rtfm.tasks.ExternalProcess">
			<property name="binary" value="scripts/dummy.sh" />
			<property name="env.set" value="RTFM_ARTIST=${music:artist}" />
			<property name="env.set" value="RTFM_ALBUM=${music:album}" />
			<property name="env.set" value="RTFM_YEAR=${music:year}" />
			<property name="env.set" value="RTFM_TITLE=${music:title}" />
			<property name="env.set" value="RTFM_TRACK=${music:track}" />
			<property name="env.set" value="RTFM_GENRE=${music:genre}" />
			<property name="env.set" value="RTFM_COMMENT=${music:comment}" />
		</task>
		<task id="downloadCover" classname="org.essembeh.rtfm.tasks.Exception">
			<property name="message" value="Download cover is not yet implemented" />
		</task>
		<task id="delete" classname="org.essembeh.rtfm.tasks.Echo">
			<property name="message" value="remove the file" />
		</task>
	</tasks>
	<actions>
		<action id="00-marskAsNonTagged" description="Mark as non tagged">
			<conditions logic="AND">
				<attributeExists name="music:tagged?" />
			</conditions>
			<workflow>
				<task ref-id="setNonTagged" />
			</workflow>
		</action>
		<action id="10-tagEyeD3" description="Tag with eyed3">
			<conditions logic="AND">
				<attributeValueEquals name="core:mime-type" value="audio/mp3" />
			</conditions>
			<workflow>
				<task ref-id="eyed3-clean" />
				<task ref-id="setNonTagged" />
				<task ref-id="eyed3-id3v2.4@utf8" />
				<task ref-id="setTagged" />
			</workflow>
		</action>
		<action id="11-tagJAudioTagger" description="Tag with JAudioTagger">
			<conditions logic="AND">
				<attributeValueEquals name="core:mime-type" value="audio/mp3" />
			</conditions>
			<workflow>
				<task ref-id="JAudioTagger-id3v2.4" />
			</workflow>
		</action>
		<action id="20-removeTags" description="Remove tags using eyed3">
			<conditions logic="AND">
				<attributeValueEquals name="core:mime-type" value="audio/mp3" />
			</conditions>
			<workflow>
				<task ref-id="eyed3-clean" />
				<task ref-id="setNonTagged" />
			</workflow>
		</action>
		<action description="Download cover" id="30-downloadCover">
			<conditions logic="AND">
				<typeEquals value="Album folder" />
			</conditions>
			<workflow>
				<task ref-id="downloadCover" />
			</workflow>
		</action>
		<action id="99-dummy" description="Dummy script">
			<conditions logic="AND">
				<true />
			</conditions>
			<workflow>
				<task ref-id="echo" />
			</workflow>
		</action>
	</actions>
</configuration-core>